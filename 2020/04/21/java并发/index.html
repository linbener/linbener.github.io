<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>java并发 | LIN is keeping learning</title><meta name="description" content="java并发"><meta name="keywords" content="java"><meta name="author" content="Lin"><meta name="copyright" content="Lin"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="java并发"><meta name="twitter:description" content="java并发"><meta name="twitter:image" content="http://yoursite.com/img/cat.jpg"><meta property="og:type" content="article"><meta property="og:title" content="java并发"><meta property="og:url" content="http://yoursite.com/2020/04/21/java%E5%B9%B6%E5%8F%91/"><meta property="og:site_name" content="LIN is keeping learning"><meta property="og:description" content="java并发"><meta property="og:image" content="http://yoursite.com/img/cat.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2020/04/21/java%E5%B9%B6%E5%8F%91/"><link rel="next" title="java图像编程" href="http://yoursite.com/2020/04/21/java%E5%9B%BE%E5%BD%A2%E7%BC%96%E7%A8%8B/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://linbener.github.io","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: {"text":"爱国,敬业,友善,诚实,自由,平等,和谐","fontSize":"12px"},
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'true',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/tou.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">6</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">3</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">1</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#线程"><span class="toc-number">1.</span> <span class="toc-text">线程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#中断线程"><span class="toc-number">1.0.1.</span> <span class="toc-text">中断线程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#线程状态"><span class="toc-number">1.0.2.</span> <span class="toc-text">线程状态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#线程属性"><span class="toc-number">1.0.3.</span> <span class="toc-text">线程属性</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#同步"><span class="toc-number">2.</span> <span class="toc-text">同步</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#锁对象"><span class="toc-number">2.0.1.</span> <span class="toc-text">锁对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#条件对象"><span class="toc-number">2.0.2.</span> <span class="toc-text">条件对象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#synchronized关键字"><span class="toc-number">2.0.3.</span> <span class="toc-text">synchronized关键字</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#同步阻塞"><span class="toc-number">2.0.4.</span> <span class="toc-text">同步阻塞</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Volatile域"><span class="toc-number">2.0.5.</span> <span class="toc-text">Volatile域</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#原子性"><span class="toc-number">2.0.6.</span> <span class="toc-text">原子性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#线程局部变量"><span class="toc-number">2.0.7.</span> <span class="toc-text">线程局部变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#读写锁"><span class="toc-number">2.0.8.</span> <span class="toc-text">读写锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#阻塞队列"><span class="toc-number">2.1.</span> <span class="toc-text">阻塞队列</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/cat.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">LIN is keeping learning</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">java并发</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2020-04-21 18:41:22"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2020-04-21</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-04-25 20:13:25"><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-04-25</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h2 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h2><h4 id="中断线程"><a href="#中断线程" class="headerlink" title="中断线程"></a>中断线程</h4><p>线程的终止只有两种情况，一是线程正常退出，二是线程出现异常。</p>
<p>在Thread对象中，没有方法可以让线程停止运行，但是可以请求线程中断，interrupt方法就是将线程的中断状态置位。请求中断的线程如果之后调用线程休眠sleep，那么会发生中断异常。</p>
<p>static boolean interrupted ()</p>
<p>测试当前线程 （ 即正在执行这一命令的线程 ） 是否被中断。 注意 ， 这是一个静态方法 。这一调用会产生副作用 是它将当前线程的中断状态重置为 false。</p>
<p>boolean islnterrupted ()<br>测试线程是否被终止， 不像静态的中断方法 ， 这一调用不改变线程的中断状态 。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Runnable runnable=()-&gt;&#123;</span><br><span class="line">    Thread thread=Thread.currentThread();</span><br><span class="line">    String name=Thread.currentThread().getName();</span><br><span class="line">    System.out.println(name+<span class="string">"  "</span>+thread.getState());<span class="comment">//运行状态</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(thread.isInterrupted());<span class="comment">//false</span></span><br><span class="line">        thread.interrupt();</span><br><span class="line">        System.out.println(thread.isInterrupted());<span class="comment">//true</span></span><br><span class="line">      <span class="comment">//  System.out.println(Thread.interrupted()); 结果为true，并把状态位重置为false,之后调用sleep,不会发生异常，因为方法的副作用。</span></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>); <span class="comment">//在thread.interrupt()调用之后，发生了异常</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        System.out.println(thread.getState());<span class="comment">//运行状态</span></span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">Thread t=<span class="keyword">new</span> Thread(runnable);</span><br><span class="line">System.out.println(Thread.currentThread().getName());</span><br><span class="line">t.start();</span><br></pre></td></tr></table></figure>

<h4 id="线程状态"><a href="#线程状态" class="headerlink" title="线程状态"></a>线程状态</h4><ol>
<li>New</li>
<li>Runnable</li>
<li>Blocked</li>
<li>Waiting</li>
<li>Timed waiting 计时等待</li>
<li>Terminated</li>
</ol>
<p>获取线程状态的方法是<code>getState()</code></p>
<p>可运行线程，一旦调用了start方法，线程就处于runnable，但是线程可运行不代表它一直处于运行状态，这取决于操作系统分配给它的时间片。</p>
<p>被阻塞线程和等待线程</p>
<p><strong>阻塞线程</strong></p>
<p>当一个<strong>线程试图获取一个内部的对象锁时</strong>，但锁被其他线程持有，所以该线程为了获取锁，进入阻塞状态，直到线程调度器允许该线程拿到锁，该线程变成非阻塞状态。</p>
<p><strong>等待线程</strong></p>
<p>当一个线程<strong>等待另一个线程通知调度器的一个条件</strong>时，它进入等待状态。 比如调用Object.wait() 或Thread.join() </p>
<p>java.util.concurrent库中的Lock或 Condition时。</p>
<p>有几个方法有一个<strong>超时参数</strong>，调用这些方法导致它们进入计时等待状态，这状态直到时间超过超时参数，或者收到通知，它们就会解除该状态。 方法，<code>Thread.sleep Object.wait Thread.join Lock.tryLock Condition.wait</code></p>
<p>阻塞线程和等待线程有很大的不同。</p>
<h4 id="线程属性"><a href="#线程属性" class="headerlink" title="线程属性"></a>线程属性</h4><p>线程优先级</p>
<p>默认情况下，一个线程的优先级继承父线程的优先级。</p>
<p><code>setPriority</code> 线程的优先级为5 ，MIN_PRIORITY=1 MAX_PRIORITY=10</p>
<p>windows系统有7个优先级，这时Java就会忽略掉自己的某些优先级，但优先级不常常有效。</p>
<p>守护线程</p>
<p>setDaemon 守护线程的作用是为其他线程提供服务，计时线程就是一个例子</p>
<p>处理未捕获异常的处理器</p>
<p>线程的run方法不能抛出任何的非受检查的异常，发生了非受检查的异常，线程就死亡了，如果线程想要处理这种异常，就要继承 <code>Thread.UncaughtExceptionHandler</code> 接口的类</p>
<h2 id="同步"><a href="#同步" class="headerlink" title="同步"></a>同步</h2><h4 id="锁对象"><a href="#锁对象" class="headerlink" title="锁对象"></a>锁对象</h4><p>在临界资源的前后，使用锁机制避免同一时间内超过两个以上的线程进入代码块。</p>
<p>Java中的锁对象是<code>java.util.concurrent.locks.ReentrantLock</code></p>
<p>使用时声明它为不可变的成员变量即可，用new创建实例，成员变量的lock unlock方法在资源的前后上锁和解锁。通常格式为  lock   try{  }finally{   unlock }</p>
<h4 id="条件对象"><a href="#条件对象" class="headerlink" title="条件对象"></a>条件对象</h4><p><code>java.util.concurrent.locks.Condition</code></p>
<p>在上锁之后，进入临界资源需要满足一定的条件，如果不满足条件就需要等待，线程进入等待队列，等到其他的线程通知。</p>
<p><strong>Condition实例需要ReentrantLock的实例对象调用<code>newCondition()</code>方法获取</strong>。</p>
<p>条件的判断用while进行判断，如果不满足调用Condition实例对象的wait方法，在解锁前需要调用实例对象的signalAll方法，唤醒等待的全部线程，signal方法会随机唤醒某一个线程，如果唤醒的线程还是不满足条件那么会继续等待，但此时没有线程运行，那么就会陷入死锁，所以为了避免死锁，一般选用signalAll方法。</p>
<p>一个例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Bank</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">double</span>[] account;</span><br><span class="line">    <span class="keyword">private</span> Lock bankLock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="keyword">private</span> Condition condition;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Bank</span><span class="params">(<span class="keyword">int</span> n,<span class="keyword">double</span> money)</span> </span>&#123;</span><br><span class="line">        account=<span class="keyword">new</span> <span class="keyword">double</span>[n];</span><br><span class="line">        Arrays.fill(account,money);</span><br><span class="line">        condition=bankLock.newCondition();<span class="comment">//获取条件变量</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(<span class="keyword">int</span> from,<span class="keyword">int</span> to,<span class="keyword">double</span> money)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"><span class="comment">//        if(account[from]&lt;money)&#123;</span></span><br><span class="line"><span class="comment">//            return;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        bankLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (account[from]&lt;money)</span><br><span class="line">            &#123;</span><br><span class="line">                condition.await();<span class="comment">//进入等待状态</span></span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">"---"</span>+bankLock.hashCode());</span><br><span class="line">            account[from] -= money;</span><br><span class="line">            System.out.println(String.format(<span class="string">"%10.2f form %d to %d"</span>, money, from, to));</span><br><span class="line">            account[to] += money;</span><br><span class="line">            System.out.println(<span class="string">"total money  ="</span> + getTotal());</span><br><span class="line">            condition.signalAll();<span class="comment">//唤醒等待的全部线程</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            bankLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getTotal</span><span class="params">()</span></span>&#123;</span><br><span class="line">        bankLock.lock();</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">double</span> a : account) &#123;</span><br><span class="line">                sum += a;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sum;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                bankLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getLength</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> account.length;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="synchronized关键字"><a href="#synchronized关键字" class="headerlink" title="synchronized关键字"></a>synchronized关键字</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">double</span> <span class="title">getTotal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">double</span> a : account) &#123;</span><br><span class="line">        sum += a;</span><br><span class="line">    &#125; <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相当于</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getTotal</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="keyword">this</span>.intrinsicLock.lock();<span class="comment">//实际上没有intrinsicLock，这里只是为了便于理解。</span></span><br><span class="line">    </span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">double</span> a : account) &#123;</span><br><span class="line">            sum += a;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.intrinsicLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>synchronized可以说是封装lock和condition的封装器，本质上还是lock,condition在底层起作用。</p>
<p><strong>对象wait,notifyAll,notify和条件变量的方法一致，唯一的区别就是不用显示地生成条件变量。</strong></p>
<p>静态方法用synchronized关键词修饰也是可以的，静态同步方法被调用时，Bank.class对象的锁被锁住。</p>
<h4 id="同步阻塞"><a href="#同步阻塞" class="headerlink" title="同步阻塞"></a>同步阻塞</h4><p>每一个Java对象都有一个锁，线程可以调用同步方法获得锁，也可以采用另一种机制获得锁，就是<strong>同步阻塞</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getTotal</span><span class="params">()</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">       <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">           <span class="keyword">double</span> sum = <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">double</span> a : account) &#123;</span><br><span class="line">               sum += a;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> sum;</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;<span class="comment">//  这里即可以获得this对象本身的锁，也可以获取成员变量或者方法参数的锁，获取方法参数的锁被称为客户端锁定</span></span><br><span class="line">code...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="Volatile域"><a href="#Volatile域" class="headerlink" title="Volatile域"></a>Volatile域</h4><p>volatile关键词为实例域同步访问提供了一种免锁机制。<strong>它让线程访问volatile变量永远都是最新的。</strong></p>
<p><strong>但是volatile变量不能提供原子性，不能确保翻转域中的值。不能保证读取 ，翻转和写入不被中断 。</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Vo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">double</span> sum;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Vo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        sum=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSum</span><span class="params">(<span class="keyword">double</span> sum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sum = sum +<span class="keyword">this</span>.sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getSum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Vo v=<span class="keyword">new</span> Vo();</span><br><span class="line"></span><br><span class="line">        Runnable r=()-&gt;&#123;v.setSum(<span class="number">1</span>);</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">"  ---"</span>+v.getSum());&#125;;</span><br><span class="line">        <span class="keyword">int</span> i=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (i&lt;=<span class="number">10</span>)&#123;</span><br><span class="line">            Thread thread=<span class="keyword">new</span> Thread(r);</span><br><span class="line">            thread.start();</span><br><span class="line">            ++i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//Thread-8  ---9.0</span></span><br><span class="line"><span class="comment">//Thread-7  ---8.0</span></span><br><span class="line"><span class="comment">//Thread-3  ---4.0</span></span><br><span class="line"><span class="comment">//Thread-2  ---3.0</span></span><br><span class="line"><span class="comment">//Thread-1  ---2.0</span></span><br><span class="line"><span class="comment">//Thread-6  ---7.0</span></span><br><span class="line"><span class="comment">//Thread-0  ---2.0</span></span><br><span class="line"><span class="comment">//Thread-4  ---5.0</span></span><br><span class="line"><span class="comment">//Thread-9  ---10.0</span></span><br><span class="line"><span class="comment">//Thread-5  ---6.0</span></span><br><span class="line"><span class="comment">//很惊讶是吗？我们让volatile变量自增10次，线程9的结果为10正合乎我们的本意，但是线程0和1输出的结果却为2，这是为什么？</span></span><br><span class="line">上面我们说了<span class="keyword">volatile</span>域让线程访问的变量永远都是最新值，但getSum获取值时，由于线程的随机运行使得线程<span class="number">0</span>访问<span class="keyword">volatile</span>变量不是它增加后的<span class="number">1</span>，而是线程<span class="number">1</span>更新后的最新值<span class="number">2</span>。这也是<span class="keyword">volatile</span>不能提供原子性的原因，不安全。</span><br></pre></td></tr></table></figure>

<p>但在部分场景volatile域也是能用的。</p>
<h4 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h4><p><code>java.util.concurrent.atomic</code></p>
<p>包下有许多的类的方法操作都是原子性的，在并发过程中保证了原子操作。</p>
<h4 id="线程局部变量"><a href="#线程局部变量" class="headerlink" title="线程局部变量"></a>线程局部变量</h4><p> java.util.Random类是线程安全的,但是如果多个线程需要等待一个共享的随机数生成器 , 这会很低效。</p>
<p>可以使用ThreadLocalRandom辅助类为每一个线程单独生成一个Random类实例。</p>
<p>总所周知SimpleDateFormat并不是线程安全的，单线程的情况下是安全的，但多线程的情况下，将会发生数据缭乱。</p>
<p><strong>线程局部辅助类<code>ThreadLocal</code>可以为每一个线程生成各自的实例。</strong></p>
<h4 id="读写锁"><a href="#读写锁" class="headerlink" title="读写锁"></a>读写锁</h4><p>锁超时tryLock() 返回布尔类型，如果获得锁为真，没有获得锁就可以去做其他的事情。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F;获取锁</span><br><span class="line">private ReentrantReadWriteLock reentrantReadWriteLock&#x3D;new ReentrantReadWriteLock();</span><br><span class="line">&#x2F;&#x2F;抽取读写锁</span><br><span class="line">private Lock read&#x3D;reentrantReadWriteLock.readLock();</span><br><span class="line">private Lock write&#x3D;reentrantReadWriteLock.writeLock();</span><br></pre></td></tr></table></figure>

<p><strong>读锁和写锁的操作和锁用法都是在临界资源前后上锁和解锁。</strong></p>
<p><strong>与普通的锁不同的是，读锁排斥写锁，写锁排斥读锁和其他的写锁。</strong></p>
<h3 id="阻塞队列"><a href="#阻塞队列" class="headerlink" title="阻塞队列"></a>阻塞队列</h3><p>对于多线程问题，如果是生产者和消费者问题，可以使用阻塞队列替代同步方法，使得数据同步。</p>
<p>生产者向队尾添加元素，消费者从队头取出元素，当队列满时添加元素，或队列空时取出元素，阻塞队列导致线程阻塞。</p>
<p>add,remove,element在队列满或空时操作会抛出异常，所以不要用这些方法。</p>
<p>而是阻塞队列当管理工具使用采用put take方法，多线程采用 offer poll peek</p>
<table>
<thead>
<tr>
<th>操作</th>
<th>抛出异常</th>
<th>返回特殊值</th>
<th>一直阻塞</th>
<th>超时退出</th>
</tr>
</thead>
<tbody><tr>
<td>插入方法</td>
<td>add</td>
<td>offer</td>
<td>put</td>
<td>offer</td>
</tr>
<tr>
<td>移除方法</td>
<td>remove</td>
<td>poll</td>
<td>take</td>
<td>poll</td>
</tr>
<tr>
<td>检查方法</td>
<td>element</td>
<td>peel</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>方法。</p>
<ol>
<li><strong>ArrayBlockingQueue</strong> ：一个由数组结构组成的有界阻塞队列。</li>
<li><strong>LinkedBlockingQueue</strong> ：一个由链表结构组成的有界阻塞队列。</li>
<li><strong>PriorityBlockingQueue</strong> ：一个支持优先级排序的无界阻塞队列。</li>
<li><strong>DelayQueue</strong>：一个使用优先级队列实现的无界阻塞队列。</li>
<li><strong>SynchronousQueue</strong>：一个不存储元素的阻塞队列。</li>
<li><strong>LinkedTransferQueue</strong>：一个由链表结构组成的无界阻塞队列。</li>
<li><strong>LinkedBlockingDeque</strong>：一个由链表结构组成的双向阻塞队列</li>
</ol>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Lin</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/04/21/java%E5%B9%B6%E5%8F%91/">http://yoursite.com/2020/04/21/java%E5%B9%B6%E5%8F%91/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/java/">java</a></div><div class="post_share"><div class="social-share" data-image="/img/cat.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/2020/04/21/java%E5%9B%BE%E5%BD%A2%E7%BC%96%E7%A8%8B/"><img class="next_cover lazyload" data-src="/img/cat.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">java图像编程</div></div></a></div></nav><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> Comment</span></div><script id="utterances_comment" src="https://utteranc.es/client.js" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script><script>var themeNow = document.documentElement.getAttribute('data-theme') === 'dark' ? 'photon-dark' : 'github-light'
document.getElementById('utterances_comment').setAttribute('theme',themeNow)

function utterancesTheme () {
var theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'photon-dark' : 'github-light'
const message = {
  type: 'set-theme',
  theme: theme
};
const iframe = document.querySelector('.utterances-frame');
iframe.contentWindow.postMessage(message, 'https://utteranc.es');
}</script></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Lin</div><div class="framework-info"><span>Driven </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">简</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="Scroll to comment"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/third-party/ClickShowText.js"></script></body></html>